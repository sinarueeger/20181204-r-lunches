<!DOCTYPE html>
<html>
  <head>
    <title>Workflow &amp; best practices for projects</title>
    <meta charset="utf-8">
    <meta name="author" content="Sina Rüeger" />
    <meta name="date" content="2018-12-04" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/ionicons/css/ionicons.min.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: top, right, title-slide

# Workflow &amp; best practices for projects
### Sina Rüeger
### 2018-12-04

---


&lt;!-- 
&lt;!-- From here: https://slides.yihui.name/xaringan/ --&gt;






---
class: left, middle

# About me

- Background in Data Analysis &amp; Engineering.

- In the past: I worked as a research assistant in data science, in epidemiology and in statistical genetics. 

- Right now: PostDoc @ EPFL <i class="ion  ion-arrow-right-a "></i> Analysis of genetic data in infectious diseases at the [Fellay Lab](https://fellay-lab.epfl.ch/).

- <i class="fab  fa-r-project " style="color:#88398a;"></i>-Ladies Lausanne co-organiser.



---
class: left, middle

# Inspiration

- [**R-Ladies Remote Journal Club**](https://twitter.com/acastillogill/status/1067699852048510976) where we discussed *Good enough practices in scientific computing* [Wil+17]. 

- **rOpenSci Community call**: *Code Review in the Lab* rOpenSci [Ope18] and the [summary](https://ropensci.org/blog/2018/11/29/codereview/) of it.

- Plus all the [references](#references) listed at the end.


---
class: center, middle, inverse

# Life cycle of projects


---
class: left, middle


&lt;img border="0" alt="" src="img/dailyworkflow/dailyworkflow.001.png" width="800"&gt;

.small[Adapted from Figure in [R4DS book](http://r4ds.had.co.nz/explore-intro.html)]

---
class: left, middle


&lt;img border="0" alt="" src="img/dailyworkflow/dailyworkflow.002.png" width="800"&gt;

.small[Adapted from Figure in [R4DS book](http://r4ds.had.co.nz/explore-intro.html)]

---
class: left, middle


&lt;img border="0" alt="" src="img/dailyworkflow/dailyworkflow.003.png" width="800"&gt;

.small[Adapted from Figure in [R4DS book](http://r4ds.had.co.nz/explore-intro.html)]




---
class: left, middle

# Goal

### 1. Figuring out stuff.

### 2. Telling others.

- Making it easy for yourself &amp; colleagues to **rerun** (and **understand**) the project → *"repeatability"*. 
- Publishing code: 
    - making it easy for others to **rerun** and to **understand** the project → [*"reproducibility"*](https://twitter.com/jtleek/status/759822823552606208). 
    - making it easy for others to rerun the code **with different data** → [*"replicability"*](https://twitter.com/jtleek/status/759822823552606208). 


---
class: left, middle

# Is that working? 


.small[*Enhancing reproducibility for computational methods* Stodden, McNutt, Bailey, Deelman, Gil, Hanson, Heroux, Ioannidis, and Taufer [Sto+16]]

---
class: left, middle 
exclude: true

# Problems

- Computers (Servers, OS, )
- Trained for domain x and not computing


---
class: left, middle

# Best practices


### Data management
### Code
### Project organisation 
### Version control

.small[A selection from *Good enough practices in scientific computing* Wilson, Bryan, Cranston, et al. [Wil+17]]


---
class: center, middle

# ...extremely well organised scientists

&lt;a href="https://docs.google.com/presentation/d/1VK1hngMZSY3FT2SrDd4_AHiB28CHrsuSsaFr7r3SAL8/edit#slide=id.p"&gt;
&lt;img border="0" alt="" src="img/heidibaya.png" width="800"&gt;
&lt;/a&gt;

.small[Extract from presentation by Heidi Seibold @HeidiBaya on [*Tools for reproducibility in Statistics and Machine Learning*](https://docs.google.com/presentation/d/1VK1hngMZSY3FT2SrDd4_AHiB28CHrsuSsaFr7r3SAL8/edit#slide=id.p)]


---
class: left, middle
exclude: true

# What are solutions?

### Data Management
    - `janitor`

### Code
    - Style guides (`lintr`, `formatr`, `styler`)
    - `bannerCommenter`
    - work with rstudio projects and `here::here()`
    
### Project Organisation 
    - runall script: `drake`
    - directory structur: `ProjectTemplate`, `pRojects`, `rrtools`

### Version control / git




---
class: left, middle

# Creating *reviewable* projects

- Having an **overview of the analysis and its iteration steps** → cleaning, modelling, visualisation, reports.

- Well styled code makes it easier to apply **code review**.


&lt;!-----------------------------------&gt;

---
class: inverse, center, middle

.large[Data Management]

---
class: left, middle

## Create data

&gt; *Create the data you wish to see in the world* [Wil+17]

- Pay attention to **variable names**.
- Use a **data dictionary** / codebook (variable meta data).
- Use and create **analysis friendly** data.


---
class: left, middle

## library(janitor)

```
library(janitor)
## remove empty table
janitor::remove_empty()

## remove duplicates
janitor::get_dupes(whatever, ID)

## clean names
iris %&gt;% names()
janitor::clean_names(iris, case = "parsed") %&gt;% names()
```


---
class: left, middle

## More

- `library(readxl)` and `library(googlesheets)` to work with spreadsheet data. 

- [`library(dataMeta)`](https://cran.r-project.org/web/packages/dataMeta/vignettes/dataMeta_Vignette.html) to create meta data of variables.




&lt;!-----------------------------------&gt;


---
class: inverse, center, middle

.large[(Styling) Code]

---
class: left, middle

## Why styling code? 

Well *styled* code makes reviewing easier. 

---
class: left, middle

## In-built options in RStudio (1/4)

- **Reindent** Lines (Cmd+I) → proper indenting

- **Reformat** Code (Cmd+Shift+A) → adds spaces, breaks long horizontal code

↪ apply both with` mycode.R`:



---
class: left, middle

## Style guides (2/4)

Styleguides: a set of opinionated rules. 

- [`library(formatr)`](https://yihui.name/formatr/) 

- [`library(styler)`](https://github.com/r-lib/styler)

---
class: left, middle

### library(formatr)

Some more details on [Yihui Xie page](https://yihui.name/formatr/). Make sure you read *6. Further Notes* about all the bad things that can happen. 

- `formatR::tidy_file("mycode.R")` will change the R file

- `formatR::tidy_source("mycode.R")` will output the styled R code


---
class: left, middle

### Bad code


```r
make.background=function(N,filename        ){
cols &lt;- c("#88398A","#B07FB2","#F7CCA4","#C8C05E","#627C63") ## generated here: http://colormind.io/

## colors
set.seed(3)
N=2000
df=data.frame(x=runif(N), y =runif(N), col = sample(cols, N, replace = TRUE), size=runif(N, 1, 10))

## no border
qp &lt;- ggplot(df, aes(x, y))+ geom_point(aes(size =size, fill =I(col), color = I(col)), alpha = 0.4, shape = 16)+theme_void()+theme(legend.position="none")+scale_size_continuous(range = c(1, 30))

return(qp)
}
```


---
class: left, middle

### Better code


```r
formatR::tidy_source("mycode.R", blank = FALSE, 
    arrow = TRUE, width.cutoff = 50)
```


```r
make.background &lt;- function(N, filename) {
    cols &lt;- c("#88398A", "#B07FB2", "#F7CCA4", 
        "#C8C05E", "#627C63")  ## generated here: http://colormind.io/
    ## colors
    set.seed(3)
    N &lt;- 2000
    df &lt;- data.frame(x = runif(N), y = runif(N), 
        col = sample(cols, N, replace = TRUE), 
        size = runif(N, 1, 10))
    ## no border
    qp &lt;- ggplot(df, aes(x, y)) + geom_point(aes(size = size, 
        fill = I(col), color = I(col)), alpha = 0.4, 
        shape = 16) + theme_void() + theme(legend.position = "none") + 
        scale_size_continuous(range = c(1, 
            30))
    return(qp)
}
```

---
class: left, middle

### library(styler)

- Follows tidyverse styling rules. 
- RStudio add-in

↪ `mycode.R`: select parts, apply `style selection`

↪ `mycode.R`: apply `style active file`



---
class: left, middle

## Linter for R code (3/4)

- `library(lintr)`

- pretty sophisticated, static code analysis

- ↪ https://github.com/jimhester/lintr


```r
lintr::lint("mycode.R")
```

---
class: left, middle

## libary(bannerCommenter) (4/4)

- For a consistent **commenting style**.

- Checkout [bannerCommenter-vignette](https://cran.r-project.org/web/packages/bannerCommenter/vignettes/Banded_comment_maker.pdf) for more options. 

- Main function is `bannerCommenter::banner()`


---
class: left, middle



```r
bannerCommenter::banner("This is an R-script Title", 
    "and this is a subtitle", emph = TRUE, 
    numLines = 3)
```

```

###########################################################################
###########################################################################
###########################################################################
###                                                                     ###
###                                                                     ###
###                      THIS IS AN R-SCRIPT TITLE                      ###
###                        AND THIS IS A SUBTITLE                       ###
###                                                                     ###
###                                                                     ###
###########################################################################
###########################################################################
###########################################################################
```


---
class: left, middle



```r
bannerCommenter::banner("Section", centre = TRUE, 
    bandChar = "/", minHashes = 70)
```

```

##/////////////////////////////////////////////////////////////////////
##                              Section                              //
##/////////////////////////////////////////////////////////////////////
```

---
class: left, middle



```r
bannerCommenter::banner("Subsection", centre = FALSE, 
    snug = TRUE, bandChar = "-")
```

```

##----------------
##  Subsection  --
##----------------
```


---
class: left, middle



```r
bannerCommenter::open_box("Important note", 
    bandChar = ":")
```

```

##::::::::::::::::::
##  Important note  
##::::::::::::::::::
```


---
class: left, middle

### Lots of more options

- *emph*: bigger, bolder banner
- *snug*: box close fitting
- *upper*: text in upper case
- *centre*: text in centre
- *leftSideHashes*: nbr of hash characters to the left
- *rightSideHashes*: nbr of hash characters to the right
- *minHashes*: length of bands (e.g. 80)
- *numLines*: nbr of lines
- *bandChar*: type of character

   
---
class: left, middle

## More

- Work with RStudio projects and `here::here()` (if you need convincing, checkout [this blogpost](https://malco.io/2018/11/05/why-should-i-use-the-here-package/)).

- More on style guides: 
  - http://adv-r.had.co.nz/Style.html
  - http://jef.works/R-style-guide/#file-names


 
&lt;!-----------------------------------&gt;
---
class: inverse, center, middle

.large[Project management]


---
class: left, middle

## Directory structure

- [`library(ProjectTemplate)`](http://projecttemplate.net/architecture.html)

- [`library(pRojects)`](https://itsalocke.com/projects/)

---
class: left, middle

### R package folder structure

&lt;a href="http://r-pkgs.had.co.nz/package.html"&gt;
&lt;img border="0" alt="" src="img/package-files.png" width="500"&gt;
&lt;/a&gt;

.small[Figure from http://r-pkgs.had.co.nz/package.html.]



---
class: left, middle

### library(ProjectTemplate)

- ↪ hhttp://projecttemplate.net/architecture.html

- ↪ hhttp://projecttemplate.net/getting_started.html


```r
library(help = ProjectTemplate)
create.project(project.name = "TB.analysis")
```

Minimal version creates folders: `cache, config, data, munge, README.md, src`


```r
create.project(project.name = "TB.analysis", 
    template = "minimal")
```


```r
## cd into project
load.project()
```


---
class: left, middle

### library(pRojects)

- Create a project layout for an analysis project

- includes support for git, packrat

- ↪ https://itsalocke.com/projects/


```r
library(pRojects)
createAnalysisProject(name = "TB.analysis", 
    title = "Analysis of TB data in NBR individuals of SOMENAME cohort", 
    folder = "/Users/rueger/Documents", git = TRUE, 
    external_setup = NULL)
```

Customise: 

```r
createAnalysisProject(name = "TB.analysis", 
    title = "Analysis of TB data in NBR individuals of SOMENAME cohort", 
    folder = "/Users/rueger/Documents", git = TRUE, 
    external_setup = NULL, dirs = c("data", 
        "docs", "output", "src", "report"))
```


---
class: left, middle

### Self baked


```
yourproject/
├── README.md
├── code
│   ├── A_dataprep.R
│   ├── B_fit.R
│   └── functions.R
├── data
│   ├── raw
│   ├── processed
│   ├── results
├── report
│   └── report.Rmd
└── yourproject.Rproj
```



---
class: left, middle

## Runall script

- runall script in `.R`
- runall script in `.sh`
- Makefile
- `library(drake)`

---
class: left, middle

## Helps you with

- **Clear instructions** → one file should contain a sort of **recipe** of the analysis.

- **Modular code** → using **functions** instead of free floating code.

- **Minimising** redundant computation → **caching** results.


```
yourproject/
├── README.md
├── runallscript
├── code
│   ├── A_dataprep.R
│   ├── B_fit.R
│   └── functions.R
├── data
│   ├── raw
│   ├── processed
│   ├── results
├── report
│   └── report.Rmd
└── yourproject.Rproj
```

---
class: left, middle

## runall script in `.R`


---
class: left, middle

## runall script in `.sh`

---
class: left, middle

## Makefile

↪ https://kbroman.org/minimal_make/

- **build automation tool** that automatically builds targets

---
class: left, middle

## More

- Project directory: 
  - https://nicercode.github.io/about/
  - https://twitter.com/EmilyRiederer/status/1038982918033604609?s=09
- Runall script: 
  - https://github.com/jdblischak/workflowr
  - https://www.tidyverse.org/articles/2017/12/workflow-vs-script/
  - https://github.com/richfitz/remake
  - `library(drake)`: [drake github repo](https://github.com/ropensci/drake)
 and [my blogpost](https://sinarueeger.github.io/2018/10/09/workflow/).

&lt;!-----------------------------------&gt;
---
class: inverse, center, middle

.large[Version control]

---
class: left, middle

# Version control

- http://happygitwithr.com/bingo.html

- Get private folders (free for students at github)


&lt;!-----------------------------------&gt;

---
class: left, middle

# Tips

1. Work with others

1. Use gist.github.io to memorise stuff, see https://gist.github.com/sinarueeger/ee42a74cbcb1d834e906199b26bc19f0



```
## Add banner comments to R scripts using 
## [bannerCommenter](https://cran.r-project.org/web/packages/bannerCommenter/vignettes/Banded_comment_maker.pdf).

## header -----------------------------
bannerCommenter::banner("G2G-EBV analysis using GASTON", emph = TRUE)

## section -----------------------------
bannerCommenter::banner("0. Setup", centre = TRUE, bandChar = "/")

## subsection -----------------------------
bannerCommenter::banner("0.1 Setup", centre = FALSE, bandChar = "-")

## note -----------------------------
bannerCommenter::open_box("Variables need to be defined", bandChar = ":")

```




---
class: left, middle

# More

- https://www.tandfonline.com/doi/full/10.1080/00031305.2017.1375986
- https://benmarwick.github.io/UO-2018-On-Ramps-to-Reproducibility/UO-2018-On-Ramps-to-Reproducibility.html#1
- cantabile

---
class: left, middle

# References

rOpenSci (2018). "Code Review in the Lab". Community Call. URL:
[https://ropensci.org/commcalls/2018-10-16/](https://ropensci.org/commcalls/2018-10-16/).

Stodden, V, M. McNutt, D. H. Bailey, et al. (2016). "Enhancing
reproducibility for computational methods". In: _Science_
354.6317, pp. 1240-1241. ISSN: 0036-8075. DOI:
[10.1126/science.aah6168](https://doi.org/10.1126/science.aah6168).
eprint:
http://science.sciencemag.org/content/354/6317/1240.full.pdf. URL:
[http://science.sciencemag.org/content/354/6317/1240](http://science.sciencemag.org/content/354/6317/1240).

Wilson, G, J. Bryan, K. Cranston, et al. (2017). "Good enough
practices in scientific computing". In: _PLOS Computational
Biology_ 13.6, pp. 1-20. DOI:
[10.1371/journal.pcbi.1005510](https://doi.org/10.1371/journal.pcbi.1005510).
URL:
[https://doi.org/10.1371/journal.pcbi.1005510](https://doi.org/10.1371/journal.pcbi.1005510).

---
class: inverse, center, middle

.big[&lt;font face="Yanone Kaffeesatz"&gt; Thank you! &lt;/font&gt;] &lt;!------<i class="fas  fa-smile "></i> ----------&gt;

.left[
Slides: [https://sinarueeger.github.io/20181204-r-lunchs-gva/#1](https://sinarueeger.github.io/20181204-r-lunchs-gva/#1)

Source code: [https://github.com/sinarueeger/20181204-r-lunchs-gva/](https://github.com/sinarueeger/20181204-r-lunchs-gva/)


<i class="fab  fa-twitter " style="color:white;"></i>: [@sinarueeger](https://twitter.com/sinarueeger)
]
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
